```{r predor, cache=cacheon}

ormod <- function(outvar, outname = NULL, data = cleandata) {
  if (is.null(outname)) outname <- outvar

  # adj
  ormod <- glm(formula(paste0(outvar, "== '1' ~ ", paste(modvars, collapse = " + "))),
    data = data,
    family = binomial(link = "logit")
  )

  sormod <- summary(ormod)

  nval <- nrow(sormod$coefficients)
  outor <- bind_cols(
    Variable = rownames(sormod$coefficients)[2:nval],
    adjor = paste0(
      fn(exp(sormod$coefficients[2:nval, 1]), 1), " (",
      fn(exp(sormod$coefficients[2:nval, 1] - global_z05 * sormod$coefficients[2:nval, 2]), 1), "-",
      fn(exp(sormod$coefficients[2:nval, 1] + global_z05 * sormod$coefficients[2:nval, 2]), 1), "), ",
      fn(sormod$coefficients[2:nval, 4], dig = 3, p = TRUE)
    )
  )

  outor <- outor %>%
    mutate(crudeor = NA_character_) %>%
    select(Variable, crudeor, adjor)

  # crude
  for (i in seq_along(modvars)) {
    ormod <- glm(formula(paste0(outvar, "== '1' ~ ", modvars[i])),
      data = data,
      family = binomial(link = "logit")
    )

    sormod <- summary(ormod)

    nval <- nrow(sormod$coefficients)
    outor_crude <- bind_cols(
      Variable = rownames(sormod$coefficients)[2:nval],
      crudeor = paste0(
        fn(exp(sormod$coefficients[2:nval, 1]), 1), " (",
        fn(exp(sormod$coefficients[2:nval, 1] - global_z05 * sormod$coefficients[2:nval, 2]), 1), "-",
        fn(exp(sormod$coefficients[2:nval, 1] + global_z05 * sormod$coefficients[2:nval, 2]), 1), "), ",
        fn(sormod$coefficients[2:nval, 4], dig = 3, p = TRUE)
      )
    )

    outor <- full_join(outor, outor_crude, by = "Variable") %>%
      mutate(crudeor = coalesce(crudeor.x, crudeor.y)) %>%
      select(Variable, crudeor, adjor)
  }

  colnames(outor) <- sanitize_text(c("Variable", "Crude OR (95% CI), p-value", "Adjusted OR (95% CI), p-value"))

  outor <- outor %>%
    mutate(
      Variable = str_remove(Variable, "1"),
      Variable = sanitize_text(Variable)
    )

  default_kable(outor,
    caption = sanitize_text(paste0("Association with pregnancy outcome - ", outname)),
    longtable = TRUE,
    escape = FALSE
  )
}

pormod <- function(outvar, outname = NULL, data = cleandata) {
  if (is.null(outname)) outname <- outvar

  mod <- polr(formula(paste0(outvar, " ~ ", paste(modvars, collapse = " + "))),
    data = data,
    Hess = TRUE
  )

  smod <- summary(mod)

  nval <- length(mod$coefficients)

  p <- (pnorm(abs(smod$coefficients[, "t value"]), lower.tail = FALSE) * 2)[1:nval]
  outor <- bind_cols(
    Variable = rownames(smod$coefficients)[1:nval],
    adjor = paste0(
      fn(exp(smod$coefficients[1:nval, 1]), 1), " (",
      fn(exp(smod$coefficients[1:nval, 1] - global_z05 * smod$coefficients[1:nval, 2]), 1), "-",
      fn(exp(smod$coefficients[1:nval, 1] + global_z05 * smod$coefficients[1:nval, 2]), 1), "), ",
      fn(p, dig = 3, p = TRUE)
    )
  )

  outor <- outor %>%
    mutate(crudeor = NA_character_) %>%
    select(Variable, crudeor, adjor)

  # crude
  for (i in seq_along(modvars)) {
    mod <- polr(formula(paste0(outvar, " ~ ", modvars[i])),
      data = data,
      Hess = TRUE
    )

    smod <- summary(mod)

    nval <- length(mod$coefficients)

    p <- (pnorm(abs(smod$coefficients[, "t value"]), lower.tail = FALSE) * 2)[1:nval]
    outor_crude <- bind_cols(
      Variable = rownames(smod$coefficients)[1:nval],
      crudeor = paste0(
        fn(exp(smod$coefficients[1:nval, 1]), 1), " (",
        fn(exp(smod$coefficients[1:nval, 1] - global_z05 * smod$coefficients[1:nval, 2]), 1), "-",
        fn(exp(smod$coefficients[1:nval, 1] + global_z05 * smod$coefficients[1:nval, 2]), 1), "), ",
        fn(p, dig = 3, p = TRUE)
      )
    )

    outor <- full_join(outor, outor_crude, by = "Variable") %>%
      mutate(crudeor = coalesce(crudeor.x, crudeor.y)) %>%
      select(Variable, crudeor, adjor)
  }

  colnames(outor) <- sanitize_text(c("Variable", "Crude OR (95% CI), p-value", "Adjusted OR (95% CI), p-value"))

  outor <- outor %>%
    mutate(
      Variable = str_remove(Variable, "1"),
      Variable = sanitize_text(Variable)
    )

  default_kable(outor,
    caption = sanitize_text(paste0("Association with pregnancy outcome - ", outname)),
    longtable = TRUE,
    escape = FALSE
  )
}
```

\clearpage

```{r predorprint1, dependson="predor", cache=cacheon}
ormod(outvarsmat[1], outname = "Maternal outcome Preeclampsia")
```

\clearpage

```{r predorprint2, dependson="predor", cache=cacheon}
ormod(outvarsmat[2], outname = "Maternal outcome Gestational hypertension")
```

\clearpage

```{r predorprint3, dependson="predor", cache=cacheon}
ormod(outvarsmat[3], outname = "Maternal outcome Gestational diabetes")
```

\clearpage

```{r predorprint4, dependson="predor", cache=cacheon}
ormod(outvarsmat[4], outname = "Maternal outcome Emergency SC")
```

\clearpage

```{r predorprint5, dependson="predor", cache=cacheon}
ormod(outvarsmat[5], outname = "Maternal outcome Placental abruption")
```

\clearpage

```{r predorprint6, dependson="predor", cache=cacheon}
pormod(outvarsneo[1], outname = "Neonatal outcome Gest age Delivery")
```

\clearpage

```{r predorprint7, dependson="predor", cache=cacheon}
ormod(outvarsneo[2], outname = "Neonatal outcome Gest age Delivery preterm")
```

\clearpage

```{r predorprint8, dependson="predor", cache=cacheon}
ormod(outvarsneo[3], outname = "Neonatal outcome Customized birth centile SGA")
```

\clearpage

```{r predorprint9, dependson="predor", cache=cacheon}
ormod(outvarsneo[4], outname = "Neonatal outcome Customized birth centile LGA")
```

\clearpage

```{r predorprint10, dependson="predor", cache=cacheon}
pormod(outvarsneo[5], outname = "Neonatal outcome Cord artery pH")
```

\clearpage

```{r predorprint11, dependson="predor", cache=cacheon}
pormod(outvarsneo[6], outname = "Neonatal outcome Cord artery BE")
```

\clearpage

```{r predorprint12, dependson="predor", cache=cacheon}
pormod(outvarsneo[7], outname = "Neonatal outcome Apgar 1 min")
```

\clearpage

```{r predorprint13, dependson="predor", cache=cacheon}
pormod(outvarsneo[8], outname = "Neonatal outcome Apgar 5 min")
```

\clearpage

```{r predorprint14, dependson="predor", cache=cacheon}
ormod(outvarsneo[9], outname = "Intubation")
```
